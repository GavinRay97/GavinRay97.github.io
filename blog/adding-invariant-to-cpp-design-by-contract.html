<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" content="#000000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Adding Design-by-Contract [[invariant]] conditions to C++, via a GCC plugin</title><meta name="robots" content="follow, index"/><meta name="description" content="Design-by-Contract&#x27;s invariant attribute allows you to enforce important properties of systems and data structures, making it an incredibly useful tool for developers. In this blog post, we&#x27;ll be exploring the development of a GCC plugin that adds support for [[invariant]] conditions in C++ classes and structs. We&#x27;ll also be looking at an example of how invariant can be used to improve the integrity of a Stack data structure. This is especially timely as GCC has recently added support for Contracts, allowing you to annotate functions with pre/post conditions. Don&#x27;t miss out on learning how to use this powerful feature in your own projects!
"/><meta property="og:url" content="https://gavinray97.github.io/blog/adding-invariant-to-cpp-design-by-contract"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Gavin Ray Blog"/><meta property="og:description" content="Design-by-Contract&#x27;s invariant attribute allows you to enforce important properties of systems and data structures, making it an incredibly useful tool for developers. In this blog post, we&#x27;ll be exploring the development of a GCC plugin that adds support for [[invariant]] conditions in C++ classes and structs. We&#x27;ll also be looking at an example of how invariant can be used to improve the integrity of a Stack data structure. This is especially timely as GCC has recently added support for Contracts, allowing you to annotate functions with pre/post conditions. Don&#x27;t miss out on learning how to use this powerful feature in your own projects!
"/><meta property="og:title" content="Adding Design-by-Contract [[invariant]] conditions to C++, via a GCC plugin"/><meta property="og:image" content="https://gavinray97.github.io/static/images/design-by-contract-logo.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/GavinRayDev"/><meta name="twitter:title" content="Adding Design-by-Contract [[invariant]] conditions to C++, via a GCC plugin"/><meta name="twitter:description" content="Design-by-Contract&#x27;s invariant attribute allows you to enforce important properties of systems and data structures, making it an incredibly useful tool for developers. In this blog post, we&#x27;ll be exploring the development of a GCC plugin that adds support for [[invariant]] conditions in C++ classes and structs. We&#x27;ll also be looking at an example of how invariant can be used to improve the integrity of a Stack data structure. This is especially timely as GCC has recently added support for Contracts, allowing you to annotate functions with pre/post conditions. Don&#x27;t miss out on learning how to use this powerful feature in your own projects!
"/><meta name="twitter:image" content="https://gavinray97.github.io/static/images/design-by-contract-logo.png"/><link rel="canonical" href="https://gavinray97.github.io/blog/adding-invariant-to-cpp-design-by-contract"/><meta property="article:published_time" content="2022-12-31T00:00:00.000Z"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://gavinray97.github.io/blog/adding-invariant-to-cpp-design-by-contract"
  },
  "headline": "Adding Design-by-Contract [[invariant]] conditions to C++, via a GCC plugin",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://gavinray97.github.io/static/images/design-by-contract-logo.png"
    }
  ],
  "datePublished": "2022-12-31T00:00:00.000Z",
  "dateModified": "2022-12-31T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Gavin Ray"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Gavin Ray",
    "logo": {
      "@type": "ImageObject",
      "url": "https://gavinray97.github.io/static/images/logo.png"
    }
  },
  "description": "Design-by-Contract's invariant attribute allows you to enforce important properties of systems and data structures, making it an incredibly useful tool for developers. In this blog post, we'll be exploring the development of a GCC plugin that adds support for [[invariant]] conditions in C++ classes and structs. We'll also be looking at an example of how invariant can be used to improve the integrity of a Stack data structure. This is especially timely as GCC has recently added support for Contracts, allowing you to annotate functions with pre/post conditions. Don't miss out on learning how to use this powerful feature in your own projects!\n"
}</script><meta name="next-head-count" content="20"/><link rel="preload" href="/_next/static/css/11bf37f52e8561b6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/11bf37f52e8561b6.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-7bdcdf64985b3467.js" defer=""></script><script src="/_next/static/chunks/main-bb8a1082161dc7c2.js" defer=""></script><script src="/_next/static/chunks/pages/_app-da15d2a3f366f449.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/207-dd685ae53e609b20.js" defer=""></script><script src="/_next/static/chunks/620-407ce78f2f46843c.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-52c7b4963ecd0646.js" defer=""></script><script src="/_next/static/yi_hyVvrRttOodt0N59ik/_buildManifest.js" defer=""></script><script src="/_next/static/yi_hyVvrRttOodt0N59ik/_ssgManifest.js" defer=""></script><script src="/_next/static/yi_hyVvrRttOodt0N59ik/_middlewareManifest.js" defer=""></script></head><body class="bg-white text-black antialiased dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex h-screen flex-col justify-between"><header class="flex items-center justify-between py-10"><div><a aria-label="" href="/"><div class="flex items-center justify-between"><div class="mr-3"></div><div class="hidden h-6 text-2xl font-semibold sm:block"></div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/blog">Blog</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/tags">Tags</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/projects">Projects</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="ml-1 mr-1 h-8 w-8 rounded p-1 sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="ml-1 mr-1 h-8 w-8 rounded py-1" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed top-24 right-0 z-10 h-full w-full transform bg-gray-200 opacity-95 duration-300 ease-in-out dark:bg-gray-800 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed h-full w-full cursor-auto focus:outline-none"></button><nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/projects">Projects</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed right-8 bottom-8 hidden flex-col gap-3 md:hidden"><button aria-label="Scroll To Comment" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button><button aria-label="Scroll To Top" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2022-12-31T00:00:00.000Z">Saturday, December 31, 2022</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Adding Design-by-Contract [[invariant]] conditions to C++, via a GCC plugin</h1></div></div></header><div class="divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:border-b xl:border-gray-200 xl:pt-11 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><img src="/static/images/me.png" width="38px" height="38px" alt="avatar" class="h-10 w-10 rounded-full"/><dl class="whitespace-nowrap text-sm font-medium leading-5"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Gavin Ray</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/GavinRayDev" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@GavinRayDev</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose max-w-none pt-10 pb-8 dark:prose-dark"><details open=""><summary class="ml-6 pb-2 pt-2 text-xl font-bold">Table of Contents</summary><div class="ml-6"><ul><li><a href="#preface">Preface</a></li><li><a href="#a-compelling-usecase">A compelling usecase</a></li><li><a href="#developing-the-gcc-plugin">Developing the GCC Plugin</a><ul><li style="margin-left:24px"><a href="#setting-up">Setting Up</a></li><li style="margin-left:24px"><a href="#initial-skeleton">Initial Skeleton</a><ul><li style="margin-left:48px"><a href="#testing-the-skeleton">Testing the Skeleton</a></li><li style="margin-left:48px"><a href="#implementing-the-invariant-call-code-generation">Implementing the [[invariant]] call code-generation</a></li><li style="margin-left:48px"><a href="#testing-again-violating-invariants">Testing again, violating invariants</a></li><li style="margin-left:48px"><a href="#checking-the-codegen-in-ghidra">Checking the codegen in Ghidra</a></li></ul></li></ul></li><li><a href="#conclusions">Conclusions</a><ul><li style="margin-left:24px"><a href="#a-request-for-help">A Request for Help</a></li></ul></li><li><a href="#thanks--acknowledgement">Thanks &amp; Acknowledgement</a></li><li><a href="#attribution">Attribution</a></li></ul></div></details><hr/><blockquote><p>Note: You can find the source code for this project here: <a target="_blank" rel="noopener noreferrer" href="https://github.com/GavinRay97/gcc-invariant-plugin">https://github.com/GavinRay97/gcc-invariant-plugin</a></p></blockquote><h1 id="preface"><a href="#preface" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Preface</h1><p>Last month, GCC landed support for <strong>Contracts</strong> in trunk:</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://gcc.gnu.org/git/?p=gcc.git;a=commit;h=ea63396f6b08f88f1cde827e6cab94cd488f7fa7">https://gcc.gnu.org/git/?p=gcc.git;a=commit;h=ea63396f6b08f88f1cde827e6cab94cd488f7fa7</a></li></ul><p>If you aren&#x27;t a C++ developer, or you are a C++ developer but haven&#x27;t followed the Contracts feature/don&#x27;t have an interest in Design-by-Contract, what this proposal does is allow you to annotate your functions with <strong>pre/post conditions</strong> that are checked when the method is called.</p><p>A trivial example might be something like:</p><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token keyword">int</span> <span class="token function">divide_returns_gt_10</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">[</span><span class="token punctuation">[</span>pre<span class="token operator">:</span> a <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> b <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment">// Avoid dividing by zero</span>
</span><span class="code-line">  <span class="token punctuation">[</span><span class="token punctuation">[</span>post r<span class="token operator">:</span> r <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span>      <span class="token comment">// Enforce that we return &gt; 10</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> a <span class="token operator">/</span> b<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>This functionality is fantastic because it allows you to encode your requirements and assertions declaratively into your methods.</p><p>But, the most powerful feature of Design-by-Contract is the <strong><code>invariant</code></strong>. An <code>invariant</code> condition allows you to write a set of assertions/assumptions about the state of an object/program that should always hold true.</p><p><strong>Invariants</strong> are incredibly useful <em><strong>for enforcing properties of systems</strong></em>, or data structures. Especially when the validity of a data structure requires conforming to a set of properties.</p><h1 id="a-compelling-usecase"><a href="#a-compelling-usecase" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>A compelling usecase</h1><p>In my free time over the last 6-8 months, I&#x27;ve been writing a database from scratch.</p><p>As a highschool dropout, this experience has been... a lot different than what I thought it would be.</p><p>There are many things you pick up as part of a CS degree that (I now know) are assumed knowledge when working on databases. One of those things is the family of B-Trees.</p><p>Like many folks, I&#x27;m on holiday, and it&#x27;s been a great time for study. Except I&#x27;ve grown exceedingly infuriated at my own seeming inability to do basic CS tasks. Like write a proper B+ Tree:</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr"><p>If anyone reads my feed and thinks:</p><br/><p>&quot;Oh hey this person knows stuff&quot;</p><br/><br/><p>Here&#x27;s what you don&#x27;t see: I&#x27;ve spent the first +20 hours of my Xmas vacation trying to write a B+ Tree and ending up with... this</p><br/><br/><p>The Spaghetti Syndr... I mean, Impasta Syndrome is real <a href="https://t.co/qOfsy34YyS">pic.twitter.com/qOfsy34YyS</a></p></p><p>‚Äî Gavin Ray (@GavinRayDev)</p><a href="https://twitter.com/GavinRayDev/status/1608136367758016512?ref_src=twsrc%5Etfw"><p>December 28, 2022</p></a></blockquote><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>My code had all the shape and feel of a tree-like structure, but it wasn&#x27;t preserving the properties of a B+ Tree.</p><p>I was ending up with garbage, and not realizing it until I had visualized it with Graphviz! üôÅ</p><p>Imagine if we had invariants that we could assert after every property change to the tree.</p><p>Below is an example of what an invariant implementation for a B-Tree data structure might look like:</p><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token keyword">struct</span> <span class="token class-name">BTree</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token punctuation">[</span><span class="token punctuation">[</span>invariant<span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line">  <span class="token keyword">void</span> <span class="token function">check_invariants</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">check_node_invariants</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// According to Knuth&#x27;s definition, a B-tree of order &quot;m&quot; is a tree which satisfies the following</span>
</span><span class="code-line">  <span class="token comment">// properties:</span>
</span><span class="code-line">  <span class="token comment">//</span>
</span><span class="code-line">  <span class="token comment">// - Every node has at most &quot;m&quot; children.</span>
</span><span class="code-line">  <span class="token comment">// - Every internal node has at least ‚åàm/2‚åâ children.</span>
</span><span class="code-line">  <span class="token comment">// - Every non-leaf node has at least two children.</span>
</span><span class="code-line">  <span class="token comment">// - All leaves appear on the same level.</span>
</span><span class="code-line">  <span class="token comment">// - A non-leaf node with k children contains k‚àí1 keys.</span>
</span><span class="code-line">  <span class="token keyword">void</span> <span class="token function">check_node_invariants</span><span class="token punctuation">(</span>Node<span class="token operator">*</span> node<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token keyword">return</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Every node has at most &quot;m&quot; children.</span>
</span><span class="code-line">    <span class="token function">assert</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>num_children <span class="token operator">&lt;=</span> MAX_VALUES <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Every internal node has at least ‚åàm/2‚åâ children.</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">is_internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token function">assert</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>num_children <span class="token operator">&gt;=</span> MIN_VALUES<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Every non-leaf node has at least two children.</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token operator">-&gt;</span><span class="token function">is_leaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token function">assert</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>num_children <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// A non-leaf node with k children contains k‚àí1 keys.</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token operator">-&gt;</span><span class="token function">is_leaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token function">assert</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>num_children <span class="token operator">==</span> node<span class="token operator">-&gt;</span>num_values <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token operator">-&gt;</span>num_children<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token function">check_node_invariants</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></code></pre></div><p>Now, assuming that this <code>check_invariants</code> method is called any time that our B-Tree changes, we can be 100% sure that it&#x27;s a proper B-Tree.</p><p>Super powerful!</p><p>The rest of this article will walk through what it means to make this sentence come to life:</p><blockquote><p><em>Now, assuming that this <code>check_invariant</code> method is called any time that our B-Tree changes...</em></p></blockquote><h1 id="developing-the-gcc-plugin"><a href="#developing-the-gcc-plugin" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Developing the GCC Plugin</h1><p>There are a few things to be said about developing GCC plugins:</p><ul><li>Documentation is essentially non-existent</li><li>There are few people with experience working with the GCC IR API&#x27;s (GIMPLE/RTL etc)</li><li>Most of existing plugins and examples you can find online have to do with analysis, and so show read-only usage of the API&#x27;s.</li></ul><p>The following code is cobbled together primarily from examples taken from these two blogposts:</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://gabrieleserra.ml/blog/2020-08-27-an-introduction-to-gcc-and-gccs-plugins.html">https://gabrieleserra.ml/blog/2020-08-27-an-introduction-to-gcc-and-gccs-plugins.html</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://stephanfr.blog/2013/05/19/building-gcc-plugins-part-1-c-11-generalized-attributes/">https://stephanfr.blog/2013/05/19/building-gcc-plugins-part-1-c-11-generalized-attributes/</a></li></ul><p>The working code for insertion of the <code>check_invariants</code> statements was a stroke of dumb luck after 15 hours, from one of the suggestions given by Github Copilot.</p><p>(More on this later. I&#x27;m not fully happy with the insertion code, because it depends on implicit fallback to the <code>this-&gt;</code> member namespace rather than an explicit call)</p><p>With that said, let&#x27;s begin!</p><h2 id="setting-up"><a href="#setting-up" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Setting Up</h2><p>If you&#x27;re following along at home (this will be an easy one, it requires just a <code>CMakeLists.txt</code> and a single <code>.cpp</code> file), this is the CMake definition we&#x27;ll be using to build and test our plugin code:</p><div class="relative"><pre><code class="code-highlight language-cmake"><span class="code-line"><span class="token keyword">project</span><span class="token punctuation">(</span>gcc-invariant-plugin<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_EXPORT_COMPILE_COMMANDS</span> <span class="token boolean">ON</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">set</span><span class="token punctuation">(</span>G++_COMPILER /usr/local/gcc-dev/bin/g++<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">set</span><span class="token punctuation">(</span>GCC_PLUGIN_DIR /usr/local/gcc-dev/lib/gcc/x86_64-linux-gnu/<span class="token number">13.0.0</span>/plugin<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">add_library</span><span class="token punctuation">(</span>gcc-invariant-plugin <span class="token namespace">SHARED</span> src/plugin.cpp<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">target_compile_options</span><span class="token punctuation">(</span>gcc-invariant-plugin <span class="token namespace">PRIVATE</span> -fno-rtti<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>gcc-invariant-plugin <span class="token namespace">PRIVATE</span> <span class="token punctuation">${</span>GCC_PLUGIN_DIR<span class="token punctuation">}</span>/include<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Copy compile_commands.json to root directory if changed</span>
</span><span class="code-line"><span class="token keyword">add_custom_command</span><span class="token punctuation">(</span>TARGET gcc-invariant-plugin POST_BUILD
</span><span class="code-line">    COMMAND <span class="token punctuation">${</span><span class="token variable">CMAKE_COMMAND</span><span class="token punctuation">}</span> -E copy_if_different
</span><span class="code-line">        <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/compile_commands.json
</span><span class="code-line">        <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span>/compile_commands.json
</span><span class="code-line"><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Command to run GCC with the build plugin using &quot;-fplugin=./libgcc-invariant-plugin.so&quot;</span>
</span><span class="code-line"><span class="token keyword">add_custom_target</span><span class="token punctuation">(</span>run-gcc ALL
</span><span class="code-line">    COMMAND <span class="token punctuation">${</span>G++_COMPILER<span class="token punctuation">}</span> -fplugin=./libgcc-invariant-plugin.so -std=c++<span class="token number">20</span> -O0 -g -ggdb3 -fcontracts
</span><span class="code-line">            -o <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span>/test-binary
</span><span class="code-line">            <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span>/test/test.cpp
</span><span class="code-line">    <span class="token property">DEPENDS</span> gcc-invariant-plugin
</span><span class="code-line">    <span class="token property">WORKING_DIRECTORY</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">)</span>
</span></code></pre></div><p>This assumes a directory layout like:</p><div class="relative"><pre><code class="code-highlight"><span class="code-line">‚îú‚îÄ‚îÄ CMakeLists.txt
</span><span class="code-line">‚îú‚îÄ‚îÄ src
</span><span class="code-line">‚îÇ   ‚îî‚îÄ‚îÄ plugin.cpp
</span><span class="code-line">‚îî‚îÄ‚îÄ test
</span><span class="code-line">    ‚îî‚îÄ‚îÄ test.cpp
</span></code></pre></div><h2 id="initial-skeleton"><a href="#initial-skeleton" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Initial Skeleton</h2><p>Now, we can mimic the structure of Gabriele&#x27;s plugin, with some slight changes and using the scoped-plugin sample from Stephan&#x27;s post. This is so that we can call our attribute [[demo::invariant]] to distinguish it from a language-level attribute.</p><p>What we want is to create a skeleton plugin that does two things:</p><ul><li>Create a new custom attribute, <code>[[demo::invariant]]</code> that we can use and check for the existence of</li><li>Hook into the parsing of struct/class member functions, and performs some &quot;Hello-world&quot; like behavior to check that it&#x27;s working as intended</li></ul><p>With these two things, we would have much of the ingredients needed for adding <code>invariant</code> support to C++!</p><p>To do this, looks something like the below:</p><ol><li>First, we include some order-sensitive (hooray!) headers:</li></ol><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token comment">// These includes are order-sensitive. GCC, am I right?...</span>
</span><span class="code-line"><span class="token comment">// clang-format off</span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;gcc-plugin.h&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;context.h&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;plugin-version.h&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;tree.h&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;gimple.h&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;tree-pass.h&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;attribs.h&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;tree-pretty-print.h&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;plugin.h&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;cp/cp-tree.h&gt;</span></span>
</span><span class="code-line"><span class="token comment">// clang-format on</span>
</span></code></pre></div><ol start="2"><li>Next, we define some general configuration settings for our plugin:</li></ol><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token keyword">namespace</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line"><span class="token comment">// -----------------------------------------------------------------------------</span>
</span><span class="code-line"><span class="token comment">// GCC PLUGIN SETUP (BASIC INFO / LICENSE / REQUIRED VERSION)</span>
</span><span class="code-line"><span class="token comment">// -----------------------------------------------------------------------------</span>
</span><span class="code-line"><span class="token keyword">constexpr</span> <span class="token keyword">auto</span> DEBUG <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">constexpr</span> <span class="token keyword">auto</span> ATTRIBUTE_NAME   <span class="token operator">=</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">constexpr</span> <span class="token keyword">auto</span> PLUGIN_VERSION   <span class="token operator">=</span> <span class="token string">&quot;0.1&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">constexpr</span> <span class="token keyword">auto</span> PLUGIN_HELP      <span class="token operator">=</span> <span class="token string">&quot;This plugin instruments functions with the invariant attribute&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">constexpr</span> <span class="token keyword">auto</span> PLUGIN_NAME      <span class="token operator">=</span> <span class="token string">&quot;invariant_plugin&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">constexpr</span> <span class="token keyword">auto</span> PLUGIN_GCC_BASEV <span class="token operator">=</span> <span class="token string">&quot;13.0.0&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> * Additional information about the plugin. Used by --help and --version
</span></span><span class="code-line"><span class="token comment"> */</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">plugin_info</span> invariant_plugin_info <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token punctuation">.</span>version <span class="token operator">=</span> PLUGIN_VERSION<span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span>help    <span class="token operator">=</span> PLUGIN_HELP<span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> * Represents the gcc version we need. Used to void using an incompatible plugin
</span></span><span class="code-line"><span class="token comment"> */</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">plugin_gcc_version</span> invariant_plugin_version <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token punctuation">.</span>basever <span class="token operator">=</span> PLUGIN_GCC_BASEV<span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// namespace</span>
</span></code></pre></div><ol start="3"><li>We define the configuration and callback handlers for a custom <code>[[demo::invariant]]</code> attribute (this does not register the attribute yet)</li></ol><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token keyword">namespace</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line"><span class="token comment">// &lt;...&gt;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// -----------------------------------------------------------------------------</span>
</span><span class="code-line"><span class="token comment">// GCC ATTRIBUTES MANAGEMENT (REGISTERING / CALLBACKS)</span>
</span><span class="code-line"><span class="token comment">// -----------------------------------------------------------------------------</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> * Attribute handler callback
</span></span><span class="code-line"><span class="token comment"> * @see Declared in tree-core.h
</span></span><span class="code-line"><span class="token comment"> */</span>
</span><span class="code-line">tree
</span><span class="code-line"><span class="token function">handle_invariant_attribute</span><span class="token punctuation">(</span>tree<span class="token operator">*</span> node<span class="token punctuation">,</span> tree name<span class="token punctuation">,</span> tree args<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> no_add_attrs<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token keyword">constexpr</span> <span class="token punctuation">(</span>DEBUG <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;&gt; Found attribute\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\tnode = &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token function">print_generic_stmt</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token operator">*</span>node<span class="token punctuation">,</span> TDF_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\tname = &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token function">print_generic_stmt</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> TDF_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token keyword">return</span> NULL_TREE<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> * Structure describing an attribute and a function to handle it
</span></span><span class="code-line"><span class="token comment"> * @see Declared in tree-core.h
</span></span><span class="code-line"><span class="token comment"> * @note Refer to tree-core for docs about
</span></span><span class="code-line"><span class="token comment"> */</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/* Attribute definition */</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_spec</span> invariant_attribute <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token comment">// [[demo::invariant]]</span>
</span><span class="code-line">  <span class="token punctuation">.</span>name                   <span class="token operator">=</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span>min_length             <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span>max_length             <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span>decl_required          <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span>type_required          <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span>function_type_required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span>affects_type_identity  <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span>handler                <span class="token operator">=</span> handle_invariant_attribute<span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span>exclude                <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// The array of attribute specs passed to register_scoped_attributes must be NULL terminated</span>
</span><span class="code-line"><span class="token keyword">const</span> attribute_spec scoped_attributes<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">  invariant_attribute<span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">{</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> * Plugin callback called during attribute registration
</span></span><span class="code-line"><span class="token comment"> */</span>
</span><span class="code-line"><span class="token keyword">void</span>
</span><span class="code-line"><span class="token function">register_attributes</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> event_data<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token function">warning</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Callback to register attributes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token function">register_scoped_attributes</span><span class="token punctuation">(</span>scoped_attributes<span class="token punctuation">,</span> <span class="token string">&quot;demo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// namespace</span>
</span></code></pre></div><ol start="4"><li>We define the configuration and handler for a GIMPLE pass, which we will eventually use to insert calls to the <code>[[demo::invariant]]</code>-marked function. For now, it only prints out the name of member functions which should be processed.</li></ol><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token keyword">namespace</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line"><span class="token comment">// &lt;...&gt;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// -----------------------------------------------------------------------------</span>
</span><span class="code-line"><span class="token comment">// PLUGIN INSTRUMENTATION LOGIC</span>
</span><span class="code-line"><span class="token comment">// -----------------------------------------------------------------------------</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> * For each function lookup attributes and insert invariant function calls
</span></span><span class="code-line"><span class="token comment"> */</span>
</span><span class="code-line"><span class="token keyword">unsigned</span> <span class="token keyword">int</span>
</span><span class="code-line"><span class="token function">instrument_invariants_plugin_exec</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token comment">// get the FUNCTION_DECL of the function whose body we are reading</span>
</span><span class="code-line">  tree fndecl <span class="token operator">=</span> current_function_decl<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// print the function name</span>
</span><span class="code-line">  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;&gt; Inspecting function &#x27;%s&#x27;\n&quot;</span><span class="token punctuation">,</span> <span class="token function">IDENTIFIER_POINTER</span><span class="token punctuation">(</span><span class="token function">DECL_NAME</span><span class="token punctuation">(</span>fndecl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// If the method is not a member of a struct/class, then skip it.</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TREE_CODE</span><span class="token punctuation">(</span><span class="token function">DECL_CONTEXT</span><span class="token punctuation">(</span>fndecl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> RECORD_TYPE<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\t - Found a member function of a struct/class\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> * Metadata for a pass, non-varying across all instances of a pass
</span></span><span class="code-line"><span class="token comment"> * @see Declared in tree-pass.h
</span></span><span class="code-line"><span class="token comment"> * @note Refer to tree-pass for docs about
</span></span><span class="code-line"><span class="token comment"> */</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pass_data</span> invariant_pass_data <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token punctuation">.</span>type                 <span class="token operator">=</span> GIMPLE_PASS<span class="token punctuation">,</span>     <span class="token comment">// type of pass</span>
</span><span class="code-line">  <span class="token punctuation">.</span>name                 <span class="token operator">=</span> PLUGIN_NAME<span class="token punctuation">,</span>     <span class="token comment">// name of plugin</span>
</span><span class="code-line">  <span class="token punctuation">.</span>optinfo_flags        <span class="token operator">=</span> OPTGROUP_NONE<span class="token punctuation">,</span>   <span class="token comment">// no opt dump</span>
</span><span class="code-line">  <span class="token punctuation">.</span>tv_id                <span class="token operator">=</span> TV_NONE<span class="token punctuation">,</span>         <span class="token comment">// no timevar (see timevar.h)</span>
</span><span class="code-line">  <span class="token punctuation">.</span>properties_required  <span class="token operator">=</span> PROP_gimple_any<span class="token punctuation">,</span> <span class="token comment">// entire gimple grammar as input</span>
</span><span class="code-line">  <span class="token punctuation">.</span>properties_provided  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment">// no prop in output</span>
</span><span class="code-line">  <span class="token punctuation">.</span>properties_destroyed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment">// no prop removed</span>
</span><span class="code-line">  <span class="token punctuation">.</span>todo_flags_start     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment">// need nothing before</span>
</span><span class="code-line">  <span class="token punctuation">.</span>todo_flags_finish <span class="token operator">=</span>
</span><span class="code-line">    TODO_update_ssa <span class="token operator">|</span> TODO_cleanup_cfg     <span class="token comment">// need to update SSA repr after and repair cfg</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> * Definition of our invariant GIMPLE pass
</span></span><span class="code-line"><span class="token comment"> * @note Extends gimple_opt_pass class
</span></span><span class="code-line"><span class="token comment"> * @see Declared in tree-pass.h
</span></span><span class="code-line"><span class="token comment"> */</span>
</span><span class="code-line"><span class="token keyword">class</span> <span class="token class-name">invariant_gimple_pass</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">gimple_opt_pass</span></span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line"><span class="token keyword">public</span><span class="token operator">:</span>
</span><span class="code-line">  <span class="token comment">/**
</span></span><span class="code-line"><span class="token comment">   * Constructor
</span></span><span class="code-line"><span class="token comment">   */</span>
</span><span class="code-line">  <span class="token function">invariant_gimple_pass</span><span class="token punctuation">(</span><span class="token keyword">const</span> pass_data<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> gcc<span class="token punctuation double-colon">::</span>context<span class="token operator">*</span> ctxt<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token operator">:</span> <span class="token function">gimple_opt_pass</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> ctxt<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">/**
</span></span><span class="code-line"><span class="token comment">   * This is the code to run when pass is executed
</span></span><span class="code-line"><span class="token comment">   * @note Defined in opt_pass father class
</span></span><span class="code-line"><span class="token comment">   * @see Defined in tree-pass.h
</span></span><span class="code-line"><span class="token comment">   */</span>
</span><span class="code-line">  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span>function<span class="token operator">*</span> exec_fun<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">instrument_invariants_plugin_exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// namespace</span>
</span></code></pre></div><ol start="5"><li>Finally, we define the entry point for the plugin, <code>plugin_init</code>, which is called by GCC when the plugin is loaded. We register the attribute and the GIMPLE pass.</li></ol><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token comment">// -----------------------------------------------------------------------------</span>
</span><span class="code-line"><span class="token comment">// PLUGIN INITIALIZATION</span>
</span><span class="code-line"><span class="token comment">// -----------------------------------------------------------------------------</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">int</span> plugin_is_GPL_compatible<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> * Initializes the plugin. Returns 0 if initialization finishes successfully.
</span></span><span class="code-line"><span class="token comment"> */</span>
</span><span class="code-line"><span class="token keyword">int</span>
</span><span class="code-line"><span class="token function">plugin_init</span><span class="token punctuation">(</span>plugin_name_args<span class="token operator">*</span> plugin_info<span class="token punctuation">,</span> plugin_gcc_version<span class="token operator">*</span> version<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">plugin_default_version_check</span><span class="token punctuation">(</span>version<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gcc_version<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token function">register_callback</span><span class="token punctuation">(</span>plugin_info<span class="token operator">-&gt;</span>base_name<span class="token punctuation">,</span> PLUGIN_INFO<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>invariant_plugin_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;&gt; plugin &#x27;%s @ %s&#x27; was loaded onto GCC\n&quot;</span><span class="token punctuation">,</span> PLUGIN_NAME<span class="token punctuation">,</span> PLUGIN_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  register_pass_info invariant_pass <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token punctuation">.</span>pass                     <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">invariant_gimple_pass</span><span class="token punctuation">(</span>invariant_pass_data<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">.</span>reference_pass_name      <span class="token operator">=</span> <span class="token string">&quot;ssa&quot;</span><span class="token punctuation">,</span> <span class="token comment">// get called after GCC has produced SSA representation</span>
</span><span class="code-line">    <span class="token punctuation">.</span>ref_pass_instance_number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>     <span class="token comment">// after first opt pass to be sure opt will not throw away</span>
</span><span class="code-line">    <span class="token punctuation">.</span>pos_op                   <span class="token operator">=</span> PASS_POS_INSERT_AFTER<span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token function">register_callback</span><span class="token punctuation">(</span>plugin_info<span class="token operator">-&gt;</span>base_name<span class="token punctuation">,</span> PLUGIN_PASS_MANAGER_SETUP<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>invariant_pass<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token function">register_callback</span><span class="token punctuation">(</span>plugin_info<span class="token operator">-&gt;</span>base_name<span class="token punctuation">,</span> PLUGIN_ATTRIBUTES<span class="token punctuation">,</span> register_attributes<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><h3 id="testing-the-skeleton"><a href="#testing-the-skeleton" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Testing the Skeleton</h3><p>Now that we have the bare-bones outline of the plugin, lets create a test-case file that we&#x27;ll use throughout the rest of this post, and run the plugin against it.</p><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token comment">// test/test.cpp</span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;cassert&gt;</span></span>
</span><span class="code-line"><span class="token property macro"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;iostream&gt;</span></span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">class</span> <span class="token class-name">Stack</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line"><span class="token keyword">private</span><span class="token operator">:</span>
</span><span class="code-line">  <span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> MAX_SIZE <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">int</span> top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">int</span> old_top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">int</span> data<span class="token punctuation">[</span>MAX_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token punctuation">[</span><span class="token punctuation">[</span>demo<span class="token punctuation double-colon">::</span>invariant<span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line">  <span class="token keyword">void</span> <span class="token function">check_invariants</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token comment">// I know this invariant/assertion is useless in combination with the [[pre]]/[[post]] conditions</span>
</span><span class="code-line">    <span class="token comment">// I just wanted to show a combination use of [[invariant]] and [[pre]]/[[post]] con</span>
</span><span class="code-line">    <span class="token function">assert</span><span class="token punctuation">(</span>top <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> top <span class="token operator">&lt;=</span> MAX_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">public</span><span class="token operator">:</span>
</span><span class="code-line">  <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> top <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token keyword">bool</span> <span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> top <span class="token operator">==</span> MAX_SIZE<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">[</span><span class="token punctuation">[</span>pre<span class="token operator">:</span> <span class="token operator">!</span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line">  <span class="token punctuation">[</span><span class="token punctuation">[</span>post<span class="token operator">:</span> top <span class="token operator">==</span> old_top <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line">  <span class="token punctuation">{</span>
</span><span class="code-line">    data<span class="token punctuation">[</span>top<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
</span><span class="code-line">    old_top <span class="token operator">=</span> top<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">int</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">[</span><span class="token punctuation">[</span>pre<span class="token operator">:</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line">  <span class="token punctuation">[</span><span class="token punctuation">[</span>post<span class="token operator">:</span> top <span class="token operator">==</span> old_top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line">  <span class="token punctuation">{</span>
</span><span class="code-line">    old_top <span class="token operator">=</span> top<span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token keyword">return</span> data<span class="token punctuation">[</span><span class="token operator">--</span>top<span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  Stack stack<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
</span><span class="code-line">    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
</span><span class="code-line">    std<span class="token punctuation double-colon">::</span>cout <span class="token operator">&lt;&lt;</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation double-colon">::</span>endl<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>If we run <code>cmake --build ./build --target run-test</code> we should see:</p><div class="relative"><pre><code class="code-highlight language-cmake"><span class="code-line">[build] &lt;built-in<span class="token punctuation">&gt;</span>: warning: Callback to register attributes
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Found attribute
</span><span class="code-line">[build] 	node = check_invariants
</span><span class="code-line">[build] 	name = invariant
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;push&#x27;
</span><span class="code-line">[build] 	 - Found a member function of a struct/class
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;pop&#x27;
</span><span class="code-line">[build] 	 - Found a member function of a struct/class
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;pop&#x27;
</span><span class="code-line">[build] 	 - Found a member function of a struct/class
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;empty&#x27;
</span><span class="code-line">[build] 	 - Found a member function of a struct/class
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;full&#x27;
</span><span class="code-line">[build] 	 - Found a member function of a struct/class
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;push&#x27;
</span><span class="code-line">[build] 	 - Found a member function of a struct/class
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;pop&#x27;
</span><span class="code-line">[build] 	 - Found a member function of a struct/class
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;__ct_base &#x27;
</span><span class="code-line">[build] 	 - Found a member function of a struct/class
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;main&#x27;
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> plugin &#x27;invariant_plugin @ <span class="token number">0.1</span>&#x27; was loaded onto GCC
</span><span class="code-line">[build] [<span class="token number">2</span>/<span class="token number">2</span>] cd /home/user/projects/gcc-invariant-plugin/build/default &amp;&amp; /home/user/projects/gcc-invariant-plugin/test-binary
</span><span class="code-line">[build] <span class="token number">99</span>
</span><span class="code-line">[build] <span class="token number">98</span>
</span><span class="code-line">...
</span><span class="code-line">[build] <span class="token number">1</span>
</span><span class="code-line">[build] <span class="token number">0</span>
</span><span class="code-line">[build] Build finished with exit code <span class="token number">0</span>
</span></code></pre></div><p>Hooray!</p><h3 id="implementing-the-invariant-call-code-generation"><a href="#implementing-the-invariant-call-code-generation" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Implementing the [[invariant]] call code-generation</h3><p>Now, we need to implement the logic to to insert calls to the member function marked <code>[[demo::invariant]]</code> (if any exists) in all other member functions of any class/struct which contains an invariant function.</p><p>There are a few nuances to this:</p><ul><li>We don&#x27;t want to insert at the <em>beginning</em> of constructors, because fields won&#x27;t have been initialized yet.</li><li>We don&#x27;t want to insert calls at the <em>end</em> of destructors, because fields will have been destroyed</li><li>There are probably others I haven&#x27;t thought about</li></ul><p>But other than that, I&#x27;ve implemented it as inserting at both the beginning and end of the function (before the <code>return</code>, if it exists)</p><p>Below is the code to do this:</p><details><summary>üëá CLICK TO EXPAND CODE üëá</summary><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token keyword">unsigned</span> <span class="token keyword">int</span>
</span><span class="code-line"><span class="token function">instrument_invariants_plugin_exec</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token comment">// get the FUNCTION_DECL of the function whose body we are reading</span>
</span><span class="code-line">  tree fndecl <span class="token operator">=</span> current_function_decl<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// print the function name</span>
</span><span class="code-line">  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;&gt; Inspecting function &#x27;%s&#x27;\n&quot;</span><span class="token punctuation">,</span> <span class="token function">FN_NAME</span><span class="token punctuation">(</span>fndecl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// If the method is not a member of a struct/class, then skip it.</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TREE_CODE</span><span class="token punctuation">(</span><span class="token function">DECL_CONTEXT</span><span class="token punctuation">(</span>fndecl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> RECORD_TYPE<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// Try to locate the [[invariant]] function</span>
</span><span class="code-line">  tree invariant_fn <span class="token operator">=</span> NULL_TREE<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token comment">// Iterate over every member function of the class</span>
</span><span class="code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span>tree f <span class="token operator">=</span> <span class="token function">TYPE_FIELDS</span><span class="token punctuation">(</span><span class="token function">DECL_FIELD_CONTEXT</span><span class="token punctuation">(</span>fndecl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> f <span class="token operator">!=</span> NULL_TREE<span class="token punctuation">;</span> f <span class="token operator">=</span> <span class="token function">DECL_CHAIN</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TREE_CODE</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">==</span> FUNCTION_DECL<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token comment">// Check if the function has an [[invariant]] attribute</span>
</span><span class="code-line">      tree attrs <span class="token operator">=</span> <span class="token function">DECL_ATTRIBUTES</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token keyword">for</span> <span class="token punctuation">(</span>tree attr <span class="token operator">=</span> attrs<span class="token punctuation">;</span> attr <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span> attr <span class="token operator">=</span> <span class="token function">TREE_CHAIN</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token comment">// Check if attribute name is &quot;invariant&quot;</span>
</span><span class="code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_attribute_name</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">get_identifier</span><span class="token punctuation">(</span><span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token punctuation">{</span>
</span><span class="code-line">          invariant_fn <span class="token operator">=</span> f<span class="token punctuation">;</span>
</span><span class="code-line">        <span class="token punctuation">}</span>
</span><span class="code-line">      <span class="token punctuation">}</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>invariant_fn <span class="token operator">==</span> NULL_TREE<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// If the method name is the same as the [[invariant]] attribute function, then skip it.</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">DECL_NAME</span><span class="token punctuation">(</span>fndecl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">DECL_NAME</span><span class="token punctuation">(</span>invariant_fn<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// attribute was in the list</span>
</span><span class="code-line">  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\t attribute %s found! \n&quot;</span><span class="token punctuation">,</span> ATTRIBUTE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// get function entry block</span>
</span><span class="code-line">  basic_block entry <span class="token operator">=</span> <span class="token function">ENTRY_BLOCK_PTR_FOR_FN</span><span class="token punctuation">(</span>cfun<span class="token punctuation">)</span><span class="token operator">-&gt;</span>next_bb<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">auto</span> insert_invariant_calls_intelligently <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token comment">// get the first statement</span>
</span><span class="code-line">    gimple<span class="token operator">*</span> first_stmt <span class="token operator">=</span> <span class="token function">gsi_stmt</span><span class="token punctuation">(</span><span class="token function">gsi_start_bb</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Skip if this is a constructor, because fields will not be initialized yet</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">DECL_CONSTRUCTOR_P</span><span class="token punctuation">(</span>fndecl<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\t skipping constructor start invariant call\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token keyword">return</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// warn the user we are adding an invariant function</span>
</span><span class="code-line">    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\t adding function call before &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token function">print_gimple_stmt</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> first_stmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> TDF_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Insert the invariant call before the current statement</span>
</span><span class="code-line">    gimple_stmt_iterator gsi <span class="token operator">=</span> <span class="token function">gsi_for_stmt</span><span class="token punctuation">(</span>first_stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token function">gsi_insert_before</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gsi<span class="token punctuation">,</span> <span class="token function">gimple_build_call</span><span class="token punctuation">(</span>invariant_fn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GSI_SAME_STMT<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Skip if destructor, because fields will have been destroyed already</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">DECL_DESTRUCTOR_P</span><span class="token punctuation">(</span>fndecl<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\t skipping destructor end invariant call\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token keyword">return</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Insert the invariant call at the end of the function, or before the return statement (if</span>
</span><span class="code-line">    <span class="token comment">// any)</span>
</span><span class="code-line">    gimple_stmt_iterator gsi2      <span class="token operator">=</span> <span class="token function">gsi_last_bb</span><span class="token punctuation">(</span><span class="token function">ENTRY_BLOCK_PTR_FOR_FN</span><span class="token punctuation">(</span>cfun<span class="token punctuation">)</span><span class="token operator">-&gt;</span>next_bb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    gimple<span class="token operator">*</span>              last_stmt <span class="token operator">=</span> <span class="token function">gsi_stmt</span><span class="token punctuation">(</span>gsi2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// Double check to ensure that the last_stmt != first_stmt</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>first_stmt <span class="token operator">==</span> last_stmt<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\t first and last statement are the same, skipping last statement\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token keyword">return</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">// If the last statement is a return statement, then insert before it</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gimple_code</span><span class="token punctuation">(</span>last_stmt<span class="token punctuation">)</span> <span class="token operator">==</span> GIMPLE_RETURN<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\t adding function call before &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token function">print_gimple_stmt</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> last_stmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> TDF_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token function">gsi_insert_before</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gsi2<span class="token punctuation">,</span> <span class="token function">gimple_build_call</span><span class="token punctuation">(</span>invariant_fn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GSI_SAME_STMT<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">    <span class="token keyword">else</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\t adding function call after &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token function">print_gimple_stmt</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> last_stmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> TDF_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token function">gsi_insert_after</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gsi2<span class="token punctuation">,</span> <span class="token function">gimple_build_call</span><span class="token punctuation">(</span>invariant_fn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GSI_SAME_STMT<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// Insert the invariant function calls at the beginning/end of fn bodies based on</span>
</span><span class="code-line">  <span class="token comment">// certain conditions (whether it&#x27;s a ctor/dtor, etc.)</span>
</span><span class="code-line">  <span class="token function">insert_invariant_calls_intelligently</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// done!</span>
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div></details><h3 id="testing-again-violating-invariants"><a href="#testing-again-violating-invariants" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Testing again, violating invariants</h3><p>If we modify our test code so that the invariant is violated:</p><div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token keyword">void</span> <span class="token function">check_invariants</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">assert</span><span class="token punctuation">(</span>top <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> top <span class="token operator">&lt;=</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</span></code></pre></div><p>And then re-compile with our plugin:</p><div class="relative"><pre><code class="code-highlight language-cmake"><span class="code-line">[build] &lt;built-in<span class="token punctuation">&gt;</span>: warning: Callback to register attributes
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Found attribute
</span><span class="code-line">[build] 	node = check_invariants
</span><span class="code-line">[build] 	name = invariant
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;push&#x27;
</span><span class="code-line">[build] 	 attribute invariant found!
</span><span class="code-line">[build] 	 adding function call before retval.1_4 = <span class="token class-name inserted">Stack::full</span> <span class="token punctuation">(</span><span class="token function">this_2</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span><span class="token punctuation">)</span>;
</span><span class="code-line">[build] 	 adding function call after <span class="token keyword">if</span> <span class="token punctuation">(</span>retval.1_4 != <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;pop&#x27;
</span><span class="code-line">[build] 	 attribute invariant found!
</span><span class="code-line">[build] 	 adding function call before retval.2_4 = <span class="token class-name inserted">Stack::empty</span> <span class="token punctuation">(</span><span class="token function">this_2</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span><span class="token punctuation">)</span>;
</span><span class="code-line">[build] 	 adding function call after <span class="token keyword">if</span> <span class="token punctuation">(</span>retval.2_4 != <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;pop&#x27;
</span><span class="code-line">[build] 	 attribute invariant found!
</span><span class="code-line">[build] 	 adding function call before _1 = <span class="token function">this_5</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span>-<span class="token punctuation">&gt;</span>top;
</span><span class="code-line">[build] 	 adding function call after <span class="token keyword">if</span> <span class="token punctuation">(</span>_1 != _3<span class="token punctuation">)</span>
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;check_invariants&#x27;
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;empty&#x27;
</span><span class="code-line">[build] 	 attribute invariant found!
</span><span class="code-line">[build] 	 adding function call before _1 = <span class="token function">this_3</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span>-<span class="token punctuation">&gt;</span>top;
</span><span class="code-line">[build] 	 adding function call after _4 = _1 == <span class="token number">0</span>;
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;full&#x27;
</span><span class="code-line">[build] 	 attribute invariant found!
</span><span class="code-line">[build] 	 adding function call before _1 = <span class="token function">this_3</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span>-<span class="token punctuation">&gt;</span>top;
</span><span class="code-line">[build] 	 adding function call after _4 = _1 == <span class="token number">100</span>;
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;push&#x27;
</span><span class="code-line">[build] 	 attribute invariant found!
</span><span class="code-line">[build] 	 adding function call before <span class="token class-name inserted">Stack::push</span> <span class="token punctuation">(</span><span class="token function">this_7</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span>, <span class="token function">value_8</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span><span class="token punctuation">)</span>;
</span><span class="code-line">[build] 	 adding function call before return;
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;pop&#x27;
</span><span class="code-line">[build] 	 attribute invariant found!
</span><span class="code-line">[build] 	 adding function call before <span class="token class-name inserted">Stack::pop</span> <span class="token punctuation">(</span><span class="token function">this_7</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span><span class="token punctuation">)</span>;
</span><span class="code-line">[build] 	 adding function call after _13 = _12;
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;__ct_base &#x27;
</span><span class="code-line">[build] 	 attribute invariant found!
</span><span class="code-line">[build] 	 skipping constructor start invariant call
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> Inspecting function &#x27;main&#x27;
</span><span class="code-line">[build] <span class="token punctuation">&gt;</span> plugin &#x27;invariant_plugin @ <span class="token number">0.1</span>&#x27; was loaded onto GCC
</span></code></pre></div><p>And run the test program, we should see:</p><div class="relative"><pre><code class="code-highlight language-sh"><span class="code-line">[user@MSI gcc-invariant-plugin]$ ./test-binary
</span><span class="code-line">test-binary: /home/user/projects/gcc-invariant-plugin/test/test.cpp:13: void Stack::check_invariants(): Assertion `top &gt;= 0 &amp;&amp; top &lt;= 50&#x27; failed.
</span><span class="code-line">Aborted
</span></code></pre></div><p>Et-voila! We&#x27;ve done it!</p><h3 id="checking-the-codegen-in-ghidra"><a href="#checking-the-codegen-in-ghidra" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Checking the codegen in Ghidra</h3><p>To be sure things have come out right, we can take a look at the compiled code in something like Ghidra.</p><blockquote><p>Note: this is stepping outside of my forte, so there might be easier ways of doing this.</p></blockquote><p>Opening <code>test-binary</code> in Ghidra, and checking the primary definition of <code>Stack.push()</code> (note that the pre/post contracts will also generate function entries) we should see the below:</p><p><img alt="ghidra-stack-push-code" src="/static/images/ghidra-check-invariants.png"/></p><h1 id="conclusions"><a href="#conclusions" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Conclusions</h1><p>So we have a plugin, and it technically works, and that&#x27;s cool. Sweet!</p><p>But remember when I said above:</p><blockquote><p>... I&#x27;m not fully happy with the insertion code, because it depends on implicit fallback to the <code>this-&gt;</code> member namespace rather than an explicit call</p></blockquote><p>With the current state of the plugin code, I&#x27;m still not fully satisfied with the GIMPLE calls used to invoke the invariant method.</p><p>I don&#x27;t pretend to be an expert on C++. I <em>think</em> letting it look up the invariant function in the current scope/context is fine.</p><p>But what it <em>should</em> do is form an explicit member-function call to <code>this-&gt;check_invariant();</code>, which I burned some ~8 hours on trying to figure out.</p><h2 id="a-request-for-help"><a href="#a-request-for-help" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>A Request for Help</h2><p>If anyone knows how to do this, please let me know. Submit an issue/PR, or reach out via email/Twitter.</p><p>I submitted questions to StackOverflow, reached out on the GCC mailing list, and even had a chat with Iain Buclaw, the maintainer of GDC (the D-language frontend for GCC).</p><p>Iain got me going down the right path I think, which I am pretty sure involves a combination of <code>lookup_member()</code> and <code>build_new_method_call()</code>, but I&#x27;ve not gotten it to work.</p><p>All the details are here in case anyone&#x27;s interested in pursuing it further:</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/questions/74964153/gcc-gimple-c-api-how-to-insert-a-call-to-a-member-function-from-another-membe">https://stackoverflow.com/questions/74964153/gcc-gimple-c-api-how-to-insert-a-call-to-a-member-function-from-another-membe</a></li></ul><h1 id="thanks--acknowledgement"><a href="#thanks--acknowledgement" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Thanks &amp; Acknowledgement</h1><p>I&#x27;d like to thank the following people:</p><ul><li>Iain Buclaw, for letting me bug him, and just generally maintaining the GDC compiler and helping with release management + infrastructure.</li><li>The authors of these two blogposts:<ul><li><a target="_blank" rel="noopener noreferrer" href="https://gabrieleserra.ml/blog/2020-08-27-an-introduction-to-gcc-and-gccs-plugins.html">https://gabrieleserra.ml/blog/2020-08-27-an-introduction-to-gcc-and-gccs-plugins.html</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://stephanfr.blog/2013/05/19/building-gcc-plugins-part-1-c-11-generalized-attributes/">https://stephanfr.blog/2013/05/19/building-gcc-plugins-part-1-c-11-generalized-attributes/</a></li></ul></li></ul><h1 id="attribution"><a href="#attribution" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Attribution</h1><p>I &quot;borrowed&quot; the image in the OpenGraph metadata tag from the below blogpost, which is well-written and worth the read. I couldn&#x27;t find any information on the page on whether it was copyright protected.</p><p>Hopefully the author doesn&#x27;t mind, if they do I&#x27;ll remove it!</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://dominikberner.ch/design-by-contract-en/">https://dominikberner.ch/design-by-contract-en/</a></li></ul></div><div class="pt-6 pb-6 text-sm text-gray-700 dark:text-gray-300"><a target="_blank" rel="nofollow" href="https://mobile.twitter.com/search?q=https%3A%2F%2Fgavinray97.github.io%2Fblog%2Fadding-invariant-to-cpp-design-by-contract">Discuss on Twitter</a> ‚Ä¢ <a target="_blank" rel="noopener noreferrer" href="https://github.com/GavinRay97/GavinRay97.github.io/blob/master/data/blog/adding-invariant-to-cpp-design-by-contract.mdx">View on GitHub</a></div><div id="comment"></div></div><footer><div class="divide-gray-200 text-sm font-medium leading-5 dark:divide-gray-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/cpp">cpp</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/gcc">gcc</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/design-by-contract">design-by-contract</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/a-day-without-a-copilot">A Day Without a Copilot: Reflections on Copilot-Driven Development</a></div></div><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/postgres-wire-protocol-jdk-21">Building a PostgreSQL Wire Protocol Server using Vanilla, Modern Java 21</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog">‚Üê Back to the blog</a></div></footer></div></div></article></div></main><footer><div class="mt-16 flex flex-col items-center"><div class="mb-3 flex space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:ray.gavin97@gmail.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/GavinRay97"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/GavinRayDev"><span class="sr-only">twitter</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a></div><div class="mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Gavin Ray</div><div> ‚Ä¢ </div><div>¬© 2025</div><div> ‚Ä¢ </div><a href="/">Gavin Ray Blog</a></div><div class="mb-8 text-sm text-gray-500 dark:text-gray-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var d=Object.create;var l=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var i=a=\u003el(a,\"__esModule\",{value:!0});var N=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),k=(a,s)=\u003e{i(a);for(var c in s)l(a,c,{get:s[c],enumerable:!0})},f=(a,s,c)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let e of h(s))!u.call(a,e)\u0026\u0026e!==\"default\"\u0026\u0026l(a,e,{get:()=\u003es[e],enumerable:!(c=p(s,e))||c.enumerable});return a},g=a=\u003ef(i(l(a!=null?d(m(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var r=N((E,o)=\u003e{o.exports=_jsx_runtime});var v={};k(v,{default:()=\u003ew,frontmatter:()=\u003eb});var n=g(r()),b={title:\"Adding Design-by-Contract [[invariant]] conditions to C++, via a GCC plugin\",date:\"2022-12-31\",tags:[\"cpp\",\"gcc\",\"design-by-contract\"],draft:!1,summary:`Design-by-Contract's invariant attribute allows you to enforce important properties of systems and data structures, making it an incredibly useful tool for developers. In this blog post, we'll be exploring the development of a GCC plugin that adds support for [[invariant]] conditions in C++ classes and structs. We'll also be looking at an example of how invariant can be used to improve the integrity of a Stack data structure. This is especially timely as GCC has recently added support for Contracts, allowing you to annotate functions with pre/post conditions. Don't miss out on learning how to use this powerful feature in your own projects!\n`,images:[\"/static/images/design-by-contract-logo.png\"]};function _(a={}){let{wrapper:s}=a.components||{};return s?(0,n.jsx)(s,Object.assign({},a,{children:(0,n.jsx)(c,{})})):c();function c(){let e=Object.assign({hr:\"hr\",blockquote:\"blockquote\",p:\"p\",a:\"a\",h1:\"h1\",span:\"span\",strong:\"strong\",ul:\"ul\",li:\"li\",pre:\"pre\",code:\"code\",em:\"em\",h2:\"h2\",ol:\"ol\",h3:\"h3\",img:\"img\"},a.components),{TOCInline:t}=e;return t||y(\"TOCInline\",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t,{toc:a.toc,indentDepth:2,asDisclosure:!0}),(0,n.jsx)(e.hr,{}),(0,n.jsx)(e.blockquote,{children:(0,n.jsxs)(e.p,{children:[\"Note: You can find the source code for this project here: \",(0,n.jsx)(e.a,{href:\"https://github.com/GavinRay97/gcc-invariant-plugin\",children:\"https://github.com/GavinRay97/gcc-invariant-plugin\"})]})}),(0,n.jsxs)(e.h1,{id:\"preface\",children:[(0,n.jsx)(e.a,{href:\"#preface\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Preface\"]}),(0,n.jsxs)(e.p,{children:[\"Last month, GCC landed support for \",(0,n.jsx)(e.strong,{children:\"Contracts\"}),\" in trunk:\"]}),(0,n.jsx)(e.ul,{children:(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://gcc.gnu.org/git/?p=gcc.git;a=commit;h=ea63396f6b08f88f1cde827e6cab94cd488f7fa7\",children:\"https://gcc.gnu.org/git/?p=gcc.git;a=commit;h=ea63396f6b08f88f1cde827e6cab94cd488f7fa7\"})})}),(0,n.jsxs)(e.p,{children:[\"If you aren't a C++ developer, or you are a C++ developer but haven't followed the Contracts feature/don't have an interest in Design-by-Contract, what this proposal does is allow you to annotate your functions with \",(0,n.jsx)(e.strong,{children:\"pre/post conditions\"}),\" that are checked when the method is called.\"]}),(0,n.jsx)(e.p,{children:\"A trivial example might be something like:\"}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"divide_returns_gt_10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" a\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" b\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"pre\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" a \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" b \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Avoid dividing by zero\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"post r\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" r \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Enforce that we return \u003e 10\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" a \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"/\"}),\" b\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,n.jsx)(e.p,{children:\"This functionality is fantastic because it allows you to encode your requirements and assertions declaratively into your methods.\"}),(0,n.jsxs)(e.p,{children:[\"But, the most powerful feature of Design-by-Contract is the \",(0,n.jsx)(e.strong,{children:(0,n.jsx)(e.code,{children:\"invariant\"})}),\". An \",(0,n.jsx)(e.code,{children:\"invariant\"}),\" condition allows you to write a set of assertions/assumptions about the state of an object/program that should always hold true.\"]}),(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.strong,{children:\"Invariants\"}),\" are incredibly useful \",(0,n.jsx)(e.em,{children:(0,n.jsx)(e.strong,{children:\"for enforcing properties of systems\"})}),\", or data structures. Especially when the validity of a data structure requires conforming to a set of properties.\"]}),(0,n.jsxs)(e.h1,{id:\"a-compelling-usecase\",children:[(0,n.jsx)(e.a,{href:\"#a-compelling-usecase\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"A compelling usecase\"]}),(0,n.jsx)(e.p,{children:\"In my free time over the last 6-8 months, I've been writing a database from scratch.\"}),(0,n.jsx)(e.p,{children:\"As a highschool dropout, this experience has been... a lot different than what I thought it would be.\"}),(0,n.jsx)(e.p,{children:\"There are many things you pick up as part of a CS degree that (I now know) are assumed knowledge when working on databases. One of those things is the family of B-Trees.\"}),(0,n.jsx)(e.p,{children:\"Like many folks, I'm on holiday, and it's been a great time for study. Except I've grown exceedingly infuriated at my own seeming inability to do basic CS tasks. Like write a proper B+ Tree:\"}),(0,n.jsxs)(\"blockquote\",{class:\"twitter-tweet\",children:[(0,n.jsxs)(\"p\",{lang:\"en\",dir:\"ltr\",children:[(0,n.jsx)(e.p,{children:\"If anyone reads my feed and thinks:\"}),(0,n.jsx)(\"br\",{}),(0,n.jsx)(e.p,{children:'\"Oh hey this person knows stuff\"'}),(0,n.jsx)(\"br\",{}),(0,n.jsx)(\"br\",{}),(0,n.jsx)(e.p,{children:\"Here's what you don't see: I've spent the first +20 hours of my Xmas vacation trying to write a B+ Tree and ending up with... this\"}),(0,n.jsx)(\"br\",{}),(0,n.jsx)(\"br\",{}),(0,n.jsxs)(e.p,{children:[\"The Spaghetti Syndr... I mean, Impasta Syndrome is real \",(0,n.jsx)(\"a\",{href:\"https://t.co/qOfsy34YyS\",children:\"pic.twitter.com/qOfsy34YyS\"})]})]}),(0,n.jsx)(e.p,{children:\"\\u2014 Gavin Ray (@GavinRayDev)\"}),(0,n.jsx)(\"a\",{href:\"https://twitter.com/GavinRayDev/status/1608136367758016512?ref_src=twsrc%5Etfw\",children:(0,n.jsx)(e.p,{children:\"December 28, 2022\"})})]}),(0,n.jsx)(\"script\",{async:!0,src:\"https://platform.twitter.com/widgets.js\",charset:\"utf-8\"}),(0,n.jsx)(e.p,{children:\"My code had all the shape and feel of a tree-like structure, but it wasn't preserving the properties of a B+ Tree.\"}),(0,n.jsx)(e.p,{children:\"I was ending up with garbage, and not realizing it until I had visualized it with Graphviz! \\u{1F641}\"}),(0,n.jsx)(e.p,{children:\"Imagine if we had invariants that we could assert after every property change to the tree.\"}),(0,n.jsx)(e.p,{children:\"Below is an example of what an invariant implementation for a B-Tree data structure might look like:\"}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"BTree\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"invariant\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"check_invariants\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"check_node_invariants\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"root\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:`// According to Knuth's definition, a B-tree of order \"m\" is a tree which satisfies the following`}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// properties:\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"//\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:'// - Every node has at most \"m\" children.'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// - Every internal node has at least \\u2308m/2\\u2309 children.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// - Every non-leaf node has at least two children.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// - All leaves appear on the same level.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// - A non-leaf node with k children contains k\\u22121 keys.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"check_node_invariants\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"Node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" node\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"node \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"nullptr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:'// Every node has at most \"m\" children.'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"assert\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"num_children \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c=\"}),\" MAX_VALUES \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Every internal node has at least \\u2308m/2\\u2309 children.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"is_internal\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"assert\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"num_children \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e=\"}),\" MIN_VALUES\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Every non-leaf node has at least two children.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"!\"}),\"node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"is_leaf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"assert\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"num_children \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// A non-leaf node with k children contains k\\u22121 keys.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"!\"}),\"node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"is_leaf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"assert\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"num_children \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"num_values \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" i \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" i \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\"}),\" node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"num_children\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" i\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"++\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"check_node_invariants\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"node\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"children\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),(0,n.jsxs)(e.p,{children:[\"Now, assuming that this \",(0,n.jsx)(e.code,{children:\"check_invariants\"}),\" method is called any time that our B-Tree changes, we can be 100% sure that it's a proper B-Tree.\"]}),(0,n.jsx)(e.p,{children:\"Super powerful!\"}),(0,n.jsx)(e.p,{children:\"The rest of this article will walk through what it means to make this sentence come to life:\"}),(0,n.jsx)(e.blockquote,{children:(0,n.jsx)(e.p,{children:(0,n.jsxs)(e.em,{children:[\"Now, assuming that this \",(0,n.jsx)(e.code,{children:\"check_invariant\"}),\" method is called any time that our B-Tree changes...\"]})})}),(0,n.jsxs)(e.h1,{id:\"developing-the-gcc-plugin\",children:[(0,n.jsx)(e.a,{href:\"#developing-the-gcc-plugin\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Developing the GCC Plugin\"]}),(0,n.jsx)(e.p,{children:\"There are a few things to be said about developing GCC plugins:\"}),(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:\"Documentation is essentially non-existent\"}),(0,n.jsx)(e.li,{children:\"There are few people with experience working with the GCC IR API's (GIMPLE/RTL etc)\"}),(0,n.jsx)(e.li,{children:\"Most of existing plugins and examples you can find online have to do with analysis, and so show read-only usage of the API's.\"})]}),(0,n.jsx)(e.p,{children:\"The following code is cobbled together primarily from examples taken from these two blogposts:\"}),(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://gabrieleserra.ml/blog/2020-08-27-an-introduction-to-gcc-and-gccs-plugins.html\",children:\"https://gabrieleserra.ml/blog/2020-08-27-an-introduction-to-gcc-and-gccs-plugins.html\"})}),(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://stephanfr.blog/2013/05/19/building-gcc-plugins-part-1-c-11-generalized-attributes/\",children:\"https://stephanfr.blog/2013/05/19/building-gcc-plugins-part-1-c-11-generalized-attributes/\"})})]}),(0,n.jsxs)(e.p,{children:[\"The working code for insertion of the \",(0,n.jsx)(e.code,{children:\"check_invariants\"}),\" statements was a stroke of dumb luck after 15 hours, from one of the suggestions given by Github Copilot.\"]}),(0,n.jsxs)(e.p,{children:[\"(More on this later. I'm not fully happy with the insertion code, because it depends on implicit fallback to the \",(0,n.jsx)(e.code,{children:\"this-\u003e\"}),\" member namespace rather than an explicit call)\"]}),(0,n.jsx)(e.p,{children:\"With that said, let's begin!\"}),(0,n.jsxs)(e.h2,{id:\"setting-up\",children:[(0,n.jsx)(e.a,{href:\"#setting-up\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Setting Up\"]}),(0,n.jsxs)(e.p,{children:[\"If you're following along at home (this will be an easy one, it requires just a \",(0,n.jsx)(e.code,{children:\"CMakeLists.txt\"}),\" and a single \",(0,n.jsx)(e.code,{children:\".cpp\"}),\" file), this is the CMake definition we'll be using to build and test our plugin code:\"]}),(0,n.jsx)(e.pre,{className:\"language-cmake\",children:(0,n.jsxs)(e.code,{className:\"code-highlight language-cmake\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"project\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"gcc-invariant-plugin\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"set\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token variable\",children:\"CMAKE_EXPORT_COMPILE_COMMANDS\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean\",children:\"ON\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"set\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"G++_COMPILER /usr/local/gcc-dev/bin/g++\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"set\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"GCC_PLUGIN_DIR /usr/local/gcc-dev/lib/gcc/x86_64-linux-gnu/\",(0,n.jsx)(e.span,{className:\"token number\",children:\"13.0.0\"}),\"/plugin\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"add_library\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"gcc-invariant-plugin \",(0,n.jsx)(e.span,{className:\"token namespace\",children:\"SHARED\"}),\" src/plugin.cpp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"target_compile_options\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"gcc-invariant-plugin \",(0,n.jsx)(e.span,{className:\"token namespace\",children:\"PRIVATE\"}),\" -fno-rtti\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"target_include_directories\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"gcc-invariant-plugin \",(0,n.jsx)(e.span,{className:\"token namespace\",children:\"PRIVATE\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"${\"}),\"GCC_PLUGIN_DIR\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),\"/include\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Copy compile_commands.json to root directory if changed\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"add_custom_command\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),`TARGET gcc-invariant-plugin POST_BUILD\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    COMMAND \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"${\"}),(0,n.jsx)(e.span,{className:\"token variable\",children:\"CMAKE_COMMAND\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),` -E copy_if_different\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"${\"}),(0,n.jsx)(e.span,{className:\"token variable\",children:\"CMAKE_CURRENT_BINARY_DIR\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`/compile_commands.json\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"${\"}),(0,n.jsx)(e.span,{className:\"token variable\",children:\"CMAKE_CURRENT_SOURCE_DIR\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`/compile_commands.json\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:'# Command to run GCC with the build plugin using \"-fplugin=./libgcc-invariant-plugin.so\"'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"add_custom_target\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),`run-gcc ALL\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    COMMAND \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"${\"}),\"G++_COMPILER\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),\" -fplugin=./libgcc-invariant-plugin.so -std=c++\",(0,n.jsx)(e.span,{className:\"token number\",children:\"20\"}),` -O0 -g -ggdb3 -fcontracts\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            -o \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"${\"}),(0,n.jsx)(e.span,{className:\"token variable\",children:\"CMAKE_CURRENT_SOURCE_DIR\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`/test-binary\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"${\"}),(0,n.jsx)(e.span,{className:\"token variable\",children:\"CMAKE_CURRENT_SOURCE_DIR\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`/test/test.cpp\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property\",children:\"DEPENDS\"}),` gcc-invariant-plugin\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token property\",children:\"WORKING_DIRECTORY\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"${\"}),(0,n.jsx)(e.span,{className:\"token variable\",children:\"CMAKE_CURRENT_BINARY_DIR\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),(0,n.jsx)(e.p,{children:\"This assumes a directory layout like:\"}),(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`\\u251C\\u2500\\u2500 CMakeLists.txt\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\\u251C\\u2500\\u2500 src\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\\u2502   \\u2514\\u2500\\u2500 plugin.cpp\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\\u2514\\u2500\\u2500 test\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    \\u2514\\u2500\\u2500 test.cpp\n`})]})}),(0,n.jsxs)(e.h2,{id:\"initial-skeleton\",children:[(0,n.jsx)(e.a,{href:\"#initial-skeleton\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Initial Skeleton\"]}),(0,n.jsx)(e.p,{children:\"Now, we can mimic the structure of Gabriele's plugin, with some slight changes and using the scoped-plugin sample from Stephan's post. This is so that we can call our attribute [[demo::invariant]] to distinguish it from a language-level attribute.\"}),(0,n.jsx)(e.p,{children:\"What we want is to create a skeleton plugin that does two things:\"}),(0,n.jsxs)(e.ul,{children:[(0,n.jsxs)(e.li,{children:[\"Create a new custom attribute, \",(0,n.jsx)(e.code,{children:\"[[demo::invariant]]\"}),\" that we can use and check for the existence of\"]}),(0,n.jsx)(e.li,{children:`Hook into the parsing of struct/class member functions, and performs some \"Hello-world\" like behavior to check that it's working as intended`})]}),(0,n.jsxs)(e.p,{children:[\"With these two things, we would have much of the ingredients needed for adding \",(0,n.jsx)(e.code,{children:\"invariant\"}),\" support to C++!\"]}),(0,n.jsx)(e.p,{children:\"To do this, looks something like the below:\"}),(0,n.jsx)(e.ol,{children:(0,n.jsx)(e.li,{children:\"First, we include some order-sensitive (hooray!) headers:\"})}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// These includes are order-sensitive. GCC, am I right?...\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// clang-format off\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003cgcc-plugin.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003ccontext.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003cplugin-version.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003ctree.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003cgimple.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003ctree-pass.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003cattribs.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003ctree-pretty-print.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003cplugin.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003ccp/cp-tree.h\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// clang-format on\"}),`\n`]})]})}),(0,n.jsx)(e.ol,{start:\"2\",children:(0,n.jsx)(e.li,{children:\"Next, we define some general configuration settings for our plugin:\"})}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"namespace\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// -----------------------------------------------------------------------------\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// GCC PLUGIN SETUP (BASIC INFO / LICENSE / REQUIRED VERSION)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// -----------------------------------------------------------------------------\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"constexpr\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"auto\"}),\" DEBUG \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"constexpr\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"auto\"}),\" ATTRIBUTE_NAME   \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"invariant\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"constexpr\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"auto\"}),\" PLUGIN_VERSION   \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"0.1\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"constexpr\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"auto\"}),\" PLUGIN_HELP      \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"This plugin instruments functions with the invariant attribute\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"constexpr\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"auto\"}),\" PLUGIN_NAME      \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"invariant_plugin\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"constexpr\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"auto\"}),\" PLUGIN_GCC_BASEV \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"13.0.0\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * Additional information about the plugin. Used by --help and --version\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"plugin_info\"}),\" invariant_plugin_info \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"version \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" PLUGIN_VERSION\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"help    \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" PLUGIN_HELP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * Represents the gcc version we need. Used to void using an incompatible plugin\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"plugin_gcc_version\"}),\" invariant_plugin_version \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"basever \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" PLUGIN_GCC_BASEV\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// namespace\"}),`\n`]})]})}),(0,n.jsx)(e.ol,{start:\"3\",children:(0,n.jsxs)(e.li,{children:[\"We define the configuration and callback handlers for a custom \",(0,n.jsx)(e.code,{children:\"[[demo::invariant]]\"}),\" attribute (this does not register the attribute yet)\"]})}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"namespace\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// \u003c...\u003e\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// -----------------------------------------------------------------------------\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// GCC ATTRIBUTES MANAGEMENT (REGISTERING / CALLBACKS)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// -----------------------------------------------------------------------------\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * Attribute handler callback\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * @see Declared in tree-core.h\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`tree\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"handle_invariant_attribute\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"tree\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" node\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" tree name\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" tree args\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" flags\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"bool\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" no_add_attrs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"constexpr\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"DEBUG \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\u003e Found attribute\\\\n\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\tnode = \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"print_generic_stmt\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"node\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" TDF_NONE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\tname = \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"print_generic_stmt\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" name\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" TDF_NONE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" NULL_TREE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * Structure describing an attribute and a function to handle it\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * @see Declared in tree-core.h\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * @note Refer to tree-core for docs about\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Attribute definition */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"attribute_spec\"}),\" invariant_attribute \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// [[demo::invariant]]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"name                   \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"invariant\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"min_length             \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"max_length             \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"decl_required          \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean\",children:\"true\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"type_required          \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean\",children:\"false\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"function_type_required \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean\",children:\"false\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"affects_type_identity  \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean\",children:\"false\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"handler                \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" handle_invariant_attribute\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"exclude                \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"nullptr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// The array of attribute specs passed to register_scoped_attributes must be NULL terminated\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" attribute_spec scoped_attributes\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  invariant_attribute\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean\",children:\"false\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean\",children:\"false\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean\",children:\"false\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token boolean\",children:\"false\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * Plugin callback called during attribute registration\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"register_attributes\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" event_data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"warning\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"Callback to register attributes\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"register_scoped_attributes\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"scoped_attributes\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"demo\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// namespace\"}),`\n`]})]})}),(0,n.jsx)(e.ol,{start:\"4\",children:(0,n.jsxs)(e.li,{children:[\"We define the configuration and handler for a GIMPLE pass, which we will eventually use to insert calls to the \",(0,n.jsx)(e.code,{children:\"[[demo::invariant]]\"}),\"-marked function. For now, it only prints out the name of member functions which should be processed.\"]})}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"namespace\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// \u003c...\u003e\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// -----------------------------------------------------------------------------\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// PLUGIN INSTRUMENTATION LOGIC\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// -----------------------------------------------------------------------------\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * For each function lookup attributes and insert invariant function calls\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"instrument_invariants_plugin_exec\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// get the FUNCTION_DECL of the function whose body we are reading\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  tree fndecl \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" current_function_decl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// print the function name\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:`\"\u003e Inspecting function '%s'\\\\n\"`}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"IDENTIFIER_POINTER\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_NAME\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fndecl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// If the method is not a member of a struct/class, then skip it.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"TREE_CODE\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_CONTEXT\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fndecl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" RECORD_TYPE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\t - Found a member function of a struct/class\\\\n\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * Metadata for a pass, non-varying across all instances of a pass\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * @see Declared in tree-pass.h\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * @note Refer to tree-pass for docs about\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"pass_data\"}),\" invariant_pass_data \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"type                 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" GIMPLE_PASS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"     \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// type of pass\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"name                 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" PLUGIN_NAME\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"     \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// name of plugin\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"optinfo_flags        \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" OPTGROUP_NONE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"   \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// no opt dump\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"tv_id                \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" TV_NONE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"         \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// no timevar (see timevar.h)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"properties_required  \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" PROP_gimple_any\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// entire gimple grammar as input\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"properties_provided  \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"               \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// no prop in output\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"properties_destroyed \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"               \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// no prop removed\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"todo_flags_start     \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"               \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// need nothing before\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"todo_flags_finish \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    TODO_update_ssa \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|\"}),\" TODO_cleanup_cfg     \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// need to update SSA repr after and repair cfg\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * Definition of our invariant GIMPLE pass\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * @note Extends gimple_opt_pass class\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * @see Declared in tree-pass.h\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"class\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"invariant_gimple_pass\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsxs)(e.span,{className:\"token base-clause\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"gimple_opt_pass\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"public\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`   * Constructor\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"   */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"invariant_gimple_pass\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" pass_data\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" gcc\",(0,n.jsx)(e.span,{className:\"token punctuation double-colon\",children:\"::\"}),\"context\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" ctxt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gimple_opt_pass\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ctxt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`   * This is the code to run when pass is executed\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`   * @note Defined in opt_pass father class\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`   * @see Defined in tree-pass.h\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"   */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"execute\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"function\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" exec_fun\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"instrument_invariants_plugin_exec\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// namespace\"}),`\n`]})]})}),(0,n.jsx)(e.ol,{start:\"5\",children:(0,n.jsxs)(e.li,{children:[\"Finally, we define the entry point for the plugin, \",(0,n.jsx)(e.code,{children:\"plugin_init\"}),\", which is called by GCC when the plugin is loaded. We register the attribute and the GIMPLE pass.\"]})}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// -----------------------------------------------------------------------------\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// PLUGIN INITIALIZATION\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// -----------------------------------------------------------------------------\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" plugin_is_GPL_compatible\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` * Initializes the plugin. Returns 0 if initialization finishes successfully.\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"plugin_init\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"plugin_name_args\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" plugin_info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" plugin_gcc_version\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" version\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"!\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"plugin_default_version_check\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"version\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"gcc_version\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"register_callback\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"plugin_info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"base_name\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" PLUGIN_INFO\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"invariant_plugin_info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"printf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:`\"\u003e plugin '%s @ %s' was loaded onto GCC\\\\n\"`}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" PLUGIN_NAME\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" PLUGIN_VERSION\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  register_pass_info invariant_pass \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"pass                     \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"invariant_gimple_pass\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"invariant_pass_data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" g\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"reference_pass_name      \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"ssa\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// get called after GCC has produced SSA representation\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ref_pass_instance_number \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"     \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// after first opt pass to be sure opt will not throw away\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"pos_op                   \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" PASS_POS_INSERT_AFTER\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"register_callback\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"plugin_info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"base_name\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" PLUGIN_PASS_MANAGER_SETUP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"invariant_pass\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"register_callback\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"plugin_info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"base_name\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" PLUGIN_ATTRIBUTES\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" register_attributes\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,n.jsxs)(e.h3,{id:\"testing-the-skeleton\",children:[(0,n.jsx)(e.a,{href:\"#testing-the-skeleton\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Testing the Skeleton\"]}),(0,n.jsx)(e.p,{children:\"Now that we have the bare-bones outline of the plugin, lets create a test-case file that we'll use throughout the rest of this post, and run the plugin against it.\"}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// test/test.cpp\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003ccassert\u003e\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token property macro\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token keyword directive\",children:\"include\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"\u003ciostream\u003e\"})]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"class\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"Stack\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"private\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"static\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"constexpr\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" MAX_SIZE \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" old_top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"MAX_SIZE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"demo\",(0,n.jsx)(e.span,{className:\"token punctuation double-colon\",children:\"::\"}),\"invariant\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"check_invariants\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// I know this invariant/assertion is useless in combination with the [[pre]]/[[post]] conditions\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// I just wanted to show a combination use of [[invariant]] and [[pre]]/[[post]] con\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"assert\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c=\"}),\" MAX_SIZE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"public\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"bool\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"empty\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"bool\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"full\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" MAX_SIZE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"push\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" value\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"pre\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"full\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"post\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" old_top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"top\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"++\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" value\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    old_top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" top\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pop\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"pre\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"empty\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"post\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" old_top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    old_top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" top\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"--\"}),\"top\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"main\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  Stack stack\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" i \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" i \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" i\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"++\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    stack\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"push\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" i \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" i \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" i\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"++\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    std\",(0,n.jsx)(e.span,{className:\"token punctuation double-colon\",children:\"::\"}),\"cout \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" stack\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"pop\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" std\",(0,n.jsx)(e.span,{className:\"token punctuation double-colon\",children:\"::\"}),\"endl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,n.jsxs)(e.p,{children:[\"If we run \",(0,n.jsx)(e.code,{children:\"cmake --build ./build --target run-test\"}),\" we should see:\"]}),(0,n.jsx)(e.pre,{className:\"language-cmake\",children:(0,n.jsxs)(e.code,{className:\"code-highlight language-cmake\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \u003cbuilt-in\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),`: warning: Callback to register attributes\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Found attribute\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \tnode = check_invariants\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \tname = invariant\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'push'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t - Found a member function of a struct/class\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'pop'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t - Found a member function of a struct/class\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'pop'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t - Found a member function of a struct/class\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'empty'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t - Found a member function of a struct/class\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'full'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t - Found a member function of a struct/class\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'push'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t - Found a member function of a struct/class\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'pop'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t - Found a member function of a struct/class\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function '__ct_base '\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t - Found a member function of a struct/class\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'main'\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),\" plugin 'invariant_plugin @ \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0.1\"}),`' was loaded onto GCC\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] [\",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),\"/\",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),`] cd /home/user/projects/gcc-invariant-plugin/build/default \u0026\u0026 /home/user/projects/gcc-invariant-plugin/test-binary\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token number\",children:\"99\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token number\",children:\"98\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`...\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] Build finished with exit code \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),`\n`]})]})}),(0,n.jsx)(e.p,{children:\"Hooray!\"}),(0,n.jsxs)(e.h3,{id:\"implementing-the-invariant-call-code-generation\",children:[(0,n.jsx)(e.a,{href:\"#implementing-the-invariant-call-code-generation\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Implementing the [[invariant]] call code-generation\"]}),(0,n.jsxs)(e.p,{children:[\"Now, we need to implement the logic to to insert calls to the member function marked \",(0,n.jsx)(e.code,{children:\"[[demo::invariant]]\"}),\" (if any exists) in all other member functions of any class/struct which contains an invariant function.\"]}),(0,n.jsx)(e.p,{children:\"There are a few nuances to this:\"}),(0,n.jsxs)(e.ul,{children:[(0,n.jsxs)(e.li,{children:[\"We don't want to insert at the \",(0,n.jsx)(e.em,{children:\"beginning\"}),\" of constructors, because fields won't have been initialized yet.\"]}),(0,n.jsxs)(e.li,{children:[\"We don't want to insert calls at the \",(0,n.jsx)(e.em,{children:\"end\"}),\" of destructors, because fields will have been destroyed\"]}),(0,n.jsx)(e.li,{children:\"There are probably others I haven't thought about\"})]}),(0,n.jsxs)(e.p,{children:[\"But other than that, I've implemented it as inserting at both the beginning and end of the function (before the \",(0,n.jsx)(e.code,{children:\"return\"}),\", if it exists)\"]}),(0,n.jsx)(e.p,{children:\"Below is the code to do this:\"}),(0,n.jsxs)(\"details\",{children:[(0,n.jsx)(\"summary\",{children:\"\\u{1F447} CLICK TO EXPAND CODE \\u{1F447}\"}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"instrument_invariants_plugin_exec\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// get the FUNCTION_DECL of the function whose body we are reading\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  tree fndecl \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" current_function_decl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// print the function name\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:`\"\u003e Inspecting function '%s'\\\\n\"`}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"FN_NAME\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fndecl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// If the method is not a member of a struct/class, then skip it.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"TREE_CODE\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_CONTEXT\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fndecl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" RECORD_TYPE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Try to locate the [[invariant]] function\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  tree invariant_fn \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" NULL_TREE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Iterate over every member function of the class\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"tree f \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"TYPE_FIELDS\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_FIELD_CONTEXT\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fndecl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" f \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" NULL_TREE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" f \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_CHAIN\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"TREE_CODE\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" FUNCTION_DECL\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Check if the function has an [[invariant]] attribute\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      tree attrs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_ATTRIBUTES\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"tree attr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" attrs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" attr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"nullptr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" attr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"TREE_CHAIN\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"attr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token comment\",children:'// Check if attribute name is \"invariant\"'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"get_attribute_name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"attr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"get_identifier\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"invariant\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          invariant_fn \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"invariant_fn \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" NULL_TREE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// If the method name is the same as the [[invariant]] attribute function, then skip it.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_NAME\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fndecl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_NAME\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"invariant_fn\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// attribute was in the list\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\t attribute %s found! \\\\n\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ATTRIBUTE_NAME\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// get function entry block\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  basic_block entry \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"ENTRY_BLOCK_PTR_FOR_FN\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"cfun\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"next_bb\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"auto\"}),\" insert_invariant_calls_intelligently \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// get the first statement\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    gimple\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" first_stmt \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gsi_stmt\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"gsi_start_bb\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"entry\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Skip if this is a constructor, because fields will not be initialized yet\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_CONSTRUCTOR_P\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fndecl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\t skipping constructor start invariant call\\\\n\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// warn the user we are adding an invariant function\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\t adding function call before \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"print_gimple_stmt\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" first_stmt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" TDF_NONE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Insert the invariant call before the current statement\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    gimple_stmt_iterator gsi \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gsi_for_stmt\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"first_stmt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gsi_insert_before\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"gsi\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gimple_build_call\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"invariant_fn\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" GSI_SAME_STMT\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Skip if destructor, because fields will have been destroyed already\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"DECL_DESTRUCTOR_P\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fndecl\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\t skipping destructor end invariant call\\\\n\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Insert the invariant call at the end of the function, or before the return statement (if\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// any)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    gimple_stmt_iterator gsi2      \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gsi_last_bb\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"ENTRY_BLOCK_PTR_FOR_FN\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"cfun\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"next_bb\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    gimple\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"              last_stmt \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gsi_stmt\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"gsi2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Double check to ensure that the last_stmt != first_stmt\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"first_stmt \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" last_stmt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\t first and last statement are the same, skipping last statement\\\\n\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// If the last statement is a return statement, then insert before it\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"gimple_code\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"last_stmt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" GIMPLE_RETURN\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\t adding function call before \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"print_gimple_stmt\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" last_stmt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" TDF_NONE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gsi_insert_before\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"gsi2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gimple_build_call\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"invariant_fn\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" GSI_SAME_STMT\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fprintf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\\\\t adding function call after \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"print_gimple_stmt\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token constant\",children:\"stderr\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" last_stmt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" TDF_NONE\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gsi_insert_after\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"gsi2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"gimple_build_call\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"invariant_fn\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" GSI_SAME_STMT\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Insert the invariant function calls at the beginning/end of fn bodies based on\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// certain conditions (whether it's a ctor/dtor, etc.)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"insert_invariant_calls_intelligently\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// done!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})})]}),(0,n.jsxs)(e.h3,{id:\"testing-again-violating-invariants\",children:[(0,n.jsx)(e.a,{href:\"#testing-again-violating-invariants\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Testing again, violating invariants\"]}),(0,n.jsx)(e.p,{children:\"If we modify our test code so that the invariant is violated:\"}),(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsx)(e.code,{className:\"language-cpp code-highlight\",children:(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"check_invariants\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"assert\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" top \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"50\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})})}),(0,n.jsx)(e.p,{children:\"And then re-compile with our plugin:\"}),(0,n.jsx)(e.pre,{className:\"language-cmake\",children:(0,n.jsxs)(e.code,{className:\"code-highlight language-cmake\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \u003cbuilt-in\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),`: warning: Callback to register attributes\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Found attribute\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \tnode = check_invariants\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \tname = invariant\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'push'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t attribute invariant found!\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call before retval.1_4 = \",(0,n.jsx)(e.span,{className:\"token class-name inserted\",children:\"Stack::full\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"this_2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"D\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`;\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call after \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"retval.1_4 != \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'pop'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t attribute invariant found!\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call before retval.2_4 = \",(0,n.jsx)(e.span,{className:\"token class-name inserted\",children:\"Stack::empty\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"this_2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"D\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`;\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call after \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"retval.2_4 != \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'pop'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t attribute invariant found!\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call before _1 = \",(0,n.jsx)(e.span,{className:\"token function\",children:\"this_5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"D\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"-\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),`top;\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call after \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_1 != _3\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'check_invariants'\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'empty'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t attribute invariant found!\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call before _1 = \",(0,n.jsx)(e.span,{className:\"token function\",children:\"this_3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"D\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"-\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),`top;\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call after _4 = _1 == \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),`;\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'full'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t attribute invariant found!\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call before _1 = \",(0,n.jsx)(e.span,{className:\"token function\",children:\"this_3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"D\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"-\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),`top;\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call after _4 = _1 == \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),`;\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'push'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t attribute invariant found!\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call before \",(0,n.jsx)(e.span,{className:\"token class-name inserted\",children:\"Stack::push\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"this_7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"D\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\", \",(0,n.jsx)(e.span,{className:\"token function\",children:\"value_8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"D\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`;\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t adding function call before return;\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'pop'\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t attribute invariant found!\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \t adding function call before \",(0,n.jsx)(e.span,{className:\"token class-name inserted\",children:\"Stack::pop\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"this_7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"D\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`;\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t adding function call after _13 = _12;\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function '__ct_base '\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t attribute invariant found!\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[build] \t skipping constructor start invariant call\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),` Inspecting function 'main'\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"[build] \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\u003e\"}),\" plugin 'invariant_plugin @ \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0.1\"}),`' was loaded onto GCC\n`]})]})}),(0,n.jsx)(e.p,{children:\"And run the test program, we should see:\"}),(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight language-sh\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`[user@MSI gcc-invariant-plugin]$ ./test-binary\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:\"test-binary: /home/user/projects/gcc-invariant-plugin/test/test.cpp:13: void Stack::check_invariants(): Assertion `top \u003e= 0 \u0026\u0026 top \u003c= 50' failed.\\n\"}),(0,n.jsx)(e.span,{className:\"code-line\",children:`Aborted\n`})]})}),(0,n.jsx)(e.p,{children:\"Et-voila! We've done it!\"}),(0,n.jsxs)(e.h3,{id:\"checking-the-codegen-in-ghidra\",children:[(0,n.jsx)(e.a,{href:\"#checking-the-codegen-in-ghidra\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Checking the codegen in Ghidra\"]}),(0,n.jsx)(e.p,{children:\"To be sure things have come out right, we can take a look at the compiled code in something like Ghidra.\"}),(0,n.jsx)(e.blockquote,{children:(0,n.jsx)(e.p,{children:\"Note: this is stepping outside of my forte, so there might be easier ways of doing this.\"})}),(0,n.jsxs)(e.p,{children:[\"Opening \",(0,n.jsx)(e.code,{children:\"test-binary\"}),\" in Ghidra, and checking the primary definition of \",(0,n.jsx)(e.code,{children:\"Stack.push()\"}),\" (note that the pre/post contracts will also generate function entries) we should see the below:\"]}),(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{alt:\"ghidra-stack-push-code\",src:\"/static/images/ghidra-check-invariants.png\"})}),(0,n.jsxs)(e.h1,{id:\"conclusions\",children:[(0,n.jsx)(e.a,{href:\"#conclusions\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Conclusions\"]}),(0,n.jsx)(e.p,{children:\"So we have a plugin, and it technically works, and that's cool. Sweet!\"}),(0,n.jsx)(e.p,{children:\"But remember when I said above:\"}),(0,n.jsx)(e.blockquote,{children:(0,n.jsxs)(e.p,{children:[\"... I'm not fully happy with the insertion code, because it depends on implicit fallback to the \",(0,n.jsx)(e.code,{children:\"this-\u003e\"}),\" member namespace rather than an explicit call\"]})}),(0,n.jsx)(e.p,{children:\"With the current state of the plugin code, I'm still not fully satisfied with the GIMPLE calls used to invoke the invariant method.\"}),(0,n.jsxs)(e.p,{children:[\"I don't pretend to be an expert on C++. I \",(0,n.jsx)(e.em,{children:\"think\"}),\" letting it look up the invariant function in the current scope/context is fine.\"]}),(0,n.jsxs)(e.p,{children:[\"But what it \",(0,n.jsx)(e.em,{children:\"should\"}),\" do is form an explicit member-function call to \",(0,n.jsx)(e.code,{children:\"this-\u003echeck_invariant();\"}),\", which I burned some ~8 hours on trying to figure out.\"]}),(0,n.jsxs)(e.h2,{id:\"a-request-for-help\",children:[(0,n.jsx)(e.a,{href:\"#a-request-for-help\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"A Request for Help\"]}),(0,n.jsx)(e.p,{children:\"If anyone knows how to do this, please let me know. Submit an issue/PR, or reach out via email/Twitter.\"}),(0,n.jsx)(e.p,{children:\"I submitted questions to StackOverflow, reached out on the GCC mailing list, and even had a chat with Iain Buclaw, the maintainer of GDC (the D-language frontend for GCC).\"}),(0,n.jsxs)(e.p,{children:[\"Iain got me going down the right path I think, which I am pretty sure involves a combination of \",(0,n.jsx)(e.code,{children:\"lookup_member()\"}),\" and \",(0,n.jsx)(e.code,{children:\"build_new_method_call()\"}),\", but I've not gotten it to work.\"]}),(0,n.jsx)(e.p,{children:\"All the details are here in case anyone's interested in pursuing it further:\"}),(0,n.jsx)(e.ul,{children:(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://stackoverflow.com/questions/74964153/gcc-gimple-c-api-how-to-insert-a-call-to-a-member-function-from-another-membe\",children:\"https://stackoverflow.com/questions/74964153/gcc-gimple-c-api-how-to-insert-a-call-to-a-member-function-from-another-membe\"})})}),(0,n.jsxs)(e.h1,{id:\"thanks--acknowledgement\",children:[(0,n.jsx)(e.a,{href:\"#thanks--acknowledgement\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Thanks \u0026 Acknowledgement\"]}),(0,n.jsx)(e.p,{children:\"I'd like to thank the following people:\"}),(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:\"Iain Buclaw, for letting me bug him, and just generally maintaining the GDC compiler and helping with release management + infrastructure.\"}),(0,n.jsxs)(e.li,{children:[\"The authors of these two blogposts:\",(0,n.jsxs)(e.ul,{children:[(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://gabrieleserra.ml/blog/2020-08-27-an-introduction-to-gcc-and-gccs-plugins.html\",children:\"https://gabrieleserra.ml/blog/2020-08-27-an-introduction-to-gcc-and-gccs-plugins.html\"})}),(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://stephanfr.blog/2013/05/19/building-gcc-plugins-part-1-c-11-generalized-attributes/\",children:\"https://stephanfr.blog/2013/05/19/building-gcc-plugins-part-1-c-11-generalized-attributes/\"})})]})]})]}),(0,n.jsxs)(e.h1,{id:\"attribution\",children:[(0,n.jsx)(e.a,{href:\"#attribution\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Attribution\"]}),(0,n.jsx)(e.p,{children:`I \"borrowed\" the image in the OpenGraph metadata tag from the below blogpost, which is well-written and worth the read. I couldn't find any information on the page on whether it was copyright protected.`}),(0,n.jsx)(e.p,{children:\"Hopefully the author doesn't mind, if they do I'll remove it!\"}),(0,n.jsx)(e.ul,{children:(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://dominikberner.ch/design-by-contract-en/\",children:\"https://dominikberner.ch/design-by-contract-en/\"})})})]})}}var w=_;function y(a,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return v;})();\n;return Component;","toc":[{"value":"Preface","url":"#preface","depth":1},{"value":"A compelling usecase","url":"#a-compelling-usecase","depth":1},{"value":"Developing the GCC Plugin","url":"#developing-the-gcc-plugin","depth":1},{"value":"Setting Up","url":"#setting-up","depth":2},{"value":"Initial Skeleton","url":"#initial-skeleton","depth":2},{"value":"Testing the Skeleton","url":"#testing-the-skeleton","depth":3},{"value":"Implementing the [[invariant]] call code-generation","url":"#implementing-the-invariant-call-code-generation","depth":3},{"value":"Testing again, violating invariants","url":"#testing-again-violating-invariants","depth":3},{"value":"Checking the codegen in Ghidra","url":"#checking-the-codegen-in-ghidra","depth":3},{"value":"Conclusions","url":"#conclusions","depth":1},{"value":"A Request for Help","url":"#a-request-for-help","depth":2},{"value":"Thanks \u0026 Acknowledgement","url":"#thanks--acknowledgement","depth":1},{"value":"Attribution","url":"#attribution","depth":1}],"frontMatter":{"readingTime":{"text":"27 min read","minutes":26.065,"time":1563900,"words":5213},"slug":"adding-invariant-to-cpp-design-by-contract","fileName":"adding-invariant-to-cpp-design-by-contract.mdx","title":"Adding Design-by-Contract [[invariant]] conditions to C++, via a GCC plugin","date":"2022-12-31T00:00:00.000Z","tags":["cpp","gcc","design-by-contract"],"draft":false,"summary":"Design-by-Contract's invariant attribute allows you to enforce important properties of systems and data structures, making it an incredibly useful tool for developers. In this blog post, we'll be exploring the development of a GCC plugin that adds support for [[invariant]] conditions in C++ classes and structs. We'll also be looking at an example of how invariant can be used to improve the integrity of a Stack data structure. This is especially timely as GCC has recently added support for Contracts, allowing you to annotate functions with pre/post conditions. Don't miss out on learning how to use this powerful feature in your own projects!\n","images":["/static/images/design-by-contract-logo.png"]}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.85,"time":51000,"words":170},"slug":["default"],"fileName":"default.md","name":"Gavin Ray","avatar":"/static/images/me.png","occupation":"Code Stuff","company":"Hasura","email":"ray.gavin97@gmail.com","twitter":"https://twitter.com/GavinRayDev","linkedin":"https://www.linkedin.com","github":"https://github.com/GavinRay97","date":null}],"prev":{"title":"A Day Without a Copilot: Reflections on Copilot-Driven Development","date":"2022-12-05T00:00:00.000Z","tags":["github-copilot","machine-learning","non-technical"],"draft":false,"summary":"A reflection on the impact of language models like Github Copilot on the experience on authoring software and the role of the developer","images":["https://camo.githubusercontent.com/b22c603c99f2733ff060b01d4b184a2504e3f4b089cd8a8b113884f7b85a4782/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f70726163746963616c6465762f696d6167652f66657463682f732d2d70454d3650587a582d2d2f635f696d616767615f7363616c652c665f6175746f2c666c5f70726f67726573736976652c685f3432302c715f6175746f2c775f313030302f68747470733a2f2f6465762d746f2d75706c6f6164732e73332e616d617a6f6e6177732e636f6d2f75706c6f6164732f61727469636c65732f36336d347072357a6e7a667172716c776e33396b2e706e67"],"slug":"a-day-without-a-copilot"},"next":{"title":"Building a PostgreSQL Wire Protocol Server using Vanilla, Modern Java 21","date":"2023-01-16T00:00:00.000Z","tags":["java","jdk","jvm","postgres","wire-protocol","databases","server"],"draft":false,"summary":"A dual-purpose tutorial to 1) Demonstrate how to implement the Simple Query Protocol, where Java is an implementation detail; 2) Show practical examples of most of the new features since JDK 17, including Records, Sealed Types, Pattern Matching for Switch, Virtual Threads, and Panama Foreign-Function \u0026 Memory API.\n","images":["/static/images/postgres-wire-protocol-display-image.png"],"slug":"postgres-wire-protocol-jdk-21"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["adding-invariant-to-cpp-design-by-contract"]},"buildId":"yi_hyVvrRttOodt0N59ik","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>